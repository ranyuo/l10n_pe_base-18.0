<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="report_saleorder_document" inherit_id="sale.report_saleorder_document">
        <!--
        <xpath expr="//h2" position="attributes">
            <attribute name="t-if">doc.sudo().company_id.external_report_layout_id.key != 'external_layout_header_compact.external_layout_header_compact'</attribute>
        </xpath>
        -->
        <xpath expr="//div[@id='informations']" position="attributes">
            <attribute name="t-if">doc.sudo().company_id.external_report_layout_id.key != 'external_layout_header_compact.external_layout_header_compact'</attribute>
        </xpath>
        
        <!-- DATOS DEL CLIENTE -->
        <xpath expr="//div[@class='page']" position="before">
            <div name="sale_order_address" t-if="doc.sudo().company_id.external_report_layout_id.key == 'external_layout_header_compact.external_layout_header_compact'"
                class="mb-2">
                <table class="w-100">
                    <tr>
                        <!-- CLIENTE -->
                        <th class="l_partner" width="10%">
                            <label t-esc="'CLIENTE '"/>
                        </th>
                        <td class="v_partner" width="50%">
                            
                            <span t-esc="(doc.partner_id.display_name or '').upper()"/>
                            <br t-if="doc.partner_id.vat"/>
                            <strong t-if="doc.partner_id.vat">
                                <i class="fa fa-id-card p-1"/>
                                 <label t-esc="'{} :'.format(doc.partner_id.l10n_latam_identification_type_id.name)"/>
                                <span t-esc="doc.partner_id.vat or '-'"/>
                            </strong>
                            <br t-if="doc.partner_id.mobile"/>
                            <strong t-if="doc.partner_id.mobile">
                                <i class="fa fa-mobile p-1"/>
                                <span t-esc="doc.partner_id.mobile or '-'"/>
                            </strong>
                            <strong t-if="doc.partner_id.phone">
                                <i class="fa fa-phone p-1"/>
                                <span t-esc="doc.partner_id.phone or '-'"/>
                            </strong>
                            <br t-if="doc.partner_id.email"/>
                            <strong t-if="doc.partner_id.email">
                                <i class="fa fa-envelope-o p-1"/>
                                <span t-esc="doc.partner_id.email or '-'"/>
                            </strong>
                        </td>

                        <!--TÉRMINOS DE PAGO-->
                        <th name="th_termino_pago" width="10%">
                            <label t-esc="'TÉRMINO PAGO ' " class="text-nowrap" />
                        </th>
                        <td name="td_termino_pago" class="label" width="30%">
                            <span t-if="doc.payment_term_id" t-esc="doc.payment_term_id.name.upper()"/>
                        </td>
                        
                    </tr>
                    <tr>
                        
                        <!-- DIRECCIÓN -->
                        <th name="th_street">
                            <label t-esc="'DIRECCIÓN  '"/>
                        </th>
                        <td name="td_street">
                            <span t-esc="'{} {}-{}-{}'.format(doc.partner_id.street or '',doc.partner_id.state_id.name or '',doc.partner_id.city_id.name or '',doc.partner_id.l10n_pe_district.name or '').upper()"/>
                        </td>
                        <!--VENDEDOR-->
                        <th name="th_vendedor" style="vertical-align: top;">
                            <label t-esc="'VENDEDOR '"/>
                        </th>
                        <td name="td_vendedor">
                            <span t-esc="(doc.data_report()['salesman_name']).upper()+' '" t-if="doc.data_report()['salesman_name']"/>
                            <strong>
                                <div class="px-1"  t-if="doc.data_report()['salesman_mobile']">
                                    <i class="fa fa-phone"  />
                                    <strong t-esc="' {}'.format(doc.data_report()['salesman_mobile'])"/>
                                </div>
                                <div class="px-1" t-if="doc.data_report()['salesman_email']">
                                    <i class="fa fa-envelope-o"/>
                                    <strong t-esc="doc.data_report()['salesman_email'] or '-'"/>
                                </div>
                            </strong>
                        </td>
                    </tr>

                    <tr>
                        <!-- FECHA EMISIÓN -->
                        <th name="th_date_order">
                            <label t-esc="'F. EMISIÓN '"/>
                        </th>
                        <td name="td_date_order">
                            <span t-field="doc.date_order"/>
                        </td>

                        <!-- REFERENCIA -->
                        <th name="th_client_order_ref">
                            <label class="text-nowrap" t-esc="'ORDEN DE COMPRA'" />
                        </th>
                        <td name="td_client_order_ref">
                            <span t-esc="(doc.client_order_ref or '').upper()"/>
                        </td>
                    </tr>

                    <tr>
                        <!-- FECHA VALIDEZ -->
                        <th name="th_validity_date">
                            <label style="white-space: nowrap;" t-esc="'F. VALIDEZ'"/>
                        </th>
                        <td name="td_validity_date">
                            <span t-field="doc.validity_date"/>
                        </td>
                        <!-- MONEDA -->
                        <th name="th_currency">
                            <label t-esc="'MONEDA'"/>
                        </th>
                        <td name="td_currency">
                            <span t-esc="doc.currency_id.currency_unit_label.upper()" t-if="doc.currency_id.currency_unit_label"/>
                            <t  t-if="doc.inverse_currency_rate != 1">- T/C: <span t-esc="'{} {}'.format(doc.company_id.currency_id.symbol,doc.inverse_currency_rate)"/></t>
                        </td>
                    </tr>
                      
                </table>
            </div>
        </xpath>

        <!--RENOMBRER LA COLUMNA TOTAL-->
        <xpath expr="//th[@name='th_subtotal']" position="attributes">
            <attribute name="style">display:none</attribute>
        </xpath>
        <xpath expr="//th[@name='th_subtotal']" position="after">
            <th name="th_subtotal" class="text-end"  groups="!external_layout_header_compact.show_sales_invoices_lines_with_taxes">
                <span >Subtotal</span>
            </th>
            <th name="th_total" class="text-end" groups="external_layout_header_compact.show_sales_invoices_lines_with_taxes">
                <span >Total</span>
            </th>
        </xpath>
        
        <xpath expr="//td[@name='td_subtotal']" position="attributes">
            <attribute name="style">display:none</attribute>
        </xpath>
        
        <!--EN LAS LINEAS DE COTIZACIÓN NO MOSTRAR LAS LINEAS DE DESCUENTO GLOBAL-->
        
        <xpath expr="//tbody[hasclass('sale_tbody')]//t//tr" position="attributes">
            <attribute name="t-if">not line.flag_discount_global</attribute>
        </xpath>


        <!--Subtotal gratis sin el precio unitario en la linea de venta es cero-->
        <xpath expr="//td[@name='td_subtotal']" position="after">
            <td name="td_subtotal" class="text-center o_price_total" groups="!external_layout_header_compact.show_sales_invoices_lines_with_taxes">
                <t t-if="line.price_total != 0">
                    <span class="text-nowrap" t-field="line.price_subtotal">27.00</span>
                </t>
                <t t-else="">
                    <span>*GRATIS*</span>
                </t>
            </td>
            <td name="td_total" class="text-center o_price_total" groups="external_layout_header_compact.show_sales_invoices_lines_with_taxes">
                <t t-if="line.price_total != 0">
                    <span class="text-nowrap" t-field="line.price_total">27.00</span>
                </t>
                <t t-else="">
                    <span>*GRATIS*</span>
                </t>
            </td>
        </xpath>

        <!--Ocultar columna de impuestos-->
        <xpath expr="//th[@name='th_taxes']" position="attributes">
            <attribute name="style">display:none</attribute>
        </xpath>
        <xpath expr="//td[@name='td_taxes']" position="attributes">
            <attribute name="style">display:none</attribute>
        </xpath>

        <xpath expr="//t[@t-foreach='lines_to_report']/t[@t-set='current_subtotal']" position="attributes">
            <attribute name="t-value">current_subtotal + line.price_total</attribute>
        </xpath>


        <!--Secuencia de Campo-->
        <xpath expr="//th[@name='th_description']" position="before">
            <th class="text-center" name="th_sequence" groups="external_layout_header_compact.show_sequential_index_in_sales_invoices_lines">#</th>
            <th class="text-center" name="th_image" groups="external_layout_header_compact.show_image_in_sales_invoices"></th>
            <th class="text-center" name="th_default_code" t-if="doc.company_id.show_default_code_quotation">Código</th>
        </xpath>
        <xpath expr="//t[@t-foreach='lines_to_report']" position="before">
            <t t-set="sequence" t-value="1"/>
        </xpath>
        <!--SE AGREGO LA SECUENCIA E IMAGEN ANTES DEL PRODUCTO-->
        <xpath expr="//td[@name='td_name']/span" position="replace">
            <span t-field="line.name" t-options="{'widget': 'text'}" t-if="not doc.company_id.show_default_code_quotation"/>
            <span t-field="line.product_id.name" t-if="doc.company_id.show_default_code_quotation"/>
        </xpath>
        <xpath expr="//td[@name='td_name']" position="before">
            <td name="td_sequence" class="text-center" groups="external_layout_header_compact.show_sequential_index_in_sales_invoices_lines"><t t-esc="sequence"/></td>
            <td name="td_image" class="text-center" groups="external_layout_header_compact.show_image_in_sales_invoices">
                <img t-if="line.product_id.image_256" t-attf-src="data:image/png;base64,{{line.product_id.image_256}}" class="img-thumbnail" style="max-width: 100px; max-height: 100px;"/>
            </td>
            <td name="td_default_code" t-if="doc.company_id.show_default_code_quotation">
                <span t-field="line.product_id.default_code"/>
            </td>
        </xpath>

        <xpath expr="//td[@name='td_subtotal']" position="after">
            <t t-set="sequence" t-value="sequence+1"/>
        </xpath>

        <!--CENTRAR ELEMENTOS DE LA COLUMNAS-->
        <xpath expr="//th[@name='th_quantity']" position="after">
            <th name="th_product_uom">UdM</th>
        </xpath>
        <xpath expr="//td[@name='td_quantity']" position="attributes">
            <attribute name="class">text-center</attribute>
        </xpath>
        <xpath expr="//td[@name='td_quantity']/span[@t-field='line.product_uom']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>
        <xpath expr="//td[@name='td_quantity']" position="after">
            <td name="td_product_uom" class="text-center">
                <span t-field="line.product_uom">units</span>
            </td>
        </xpath>

        <!--Precio unitario sin impuestos con dos decimales-->
        <xpath expr="//td[@name='td_priceunit']" position="attributes">
            <attribute name="class">text-center</attribute>
        </xpath>
        <xpath expr="//td[@name='td_priceunit']/span" position="replace">
            <t t-if="line.product_uom_qty != 0">
                <span t-esc="doc.currency_id.symbol"/>
                <span class="text-nowrap" 
                        t-esc="line.price_total/((1-line.discount/100)*line.product_uom_qty)" 
                        t-options="{'widget':'float','decimal_precision':'Product Price'}"        
                        groups="external_layout_header_compact.show_sales_invoices_lines_with_taxes"/>
                <span class="text-nowrap" 
                      t-esc="line.price_subtotal/((1-line.discount/100)*line.product_uom_qty)" 
                      t-options="{'widget':'float','decimal_precision':'Product Price'}"
                      groups="!external_layout_header_compact.show_sales_invoices_lines_with_taxes"/>
            </t>
            <t t-else="">
                <span class="text-nowrap" t-field="line.price_unit" >9.00</span>
            </t>
        </xpath>

        <!--BANCOS DE COMPAÑIA-->
        <xpath expr="//span[@name='order_note']" position="before">
            <div class="no-break" groups="external_layout_header_compact.show_account_banks">
                <table class="table table-bordered bank-table mt-3">
                    <thead>
                        <tr>
                            <th scope="col" class="text-center">BANCO</th>
                            <th scope="col" class="text-center">MONEDA</th>
                            <th scope="col" class="text-center">NRO. CUENTA</th>
                            <th scope="col" class="text-center">NRO. CUENTA CCI</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="doc.company_id.bank_ids" t-as="bank">
                            <tr t-if="bank.allow_out_payment">
                                <td class="text-center"><span t-esc="bank.bank_id.name"/></td>
                                <td class="text-center"><span t-esc="bank.currency_id.currency_unit_label"/></td>
                                <td class="text-center"><span t-field="bank.acc_number"/></td>
                                <td class="text-center"><span t-field="bank.cci_number"/></td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </xpath>
        
        <xpath expr="//table//t[@t-call='sale.document_tax_totals']" position="after">
            
            <t t-set="tax_totals" t-value="doc.tax_totals"/>
            <t t-set="inverse_currency_rate" t-value="doc.inverse_currency_rate"/>

            <!--MOSTRAR DESCUENTOS CON SU SUBTOTALES-->
            <t t-if="doc.total_discounts" groups="external_layout_header_compact.show_sales_invoices_lines_with_taxes">
                <tr name="subtotal_before_discount">
                    <td>
                        <strong>SUBTOTAL</strong>
                    </td>
                    <td class="text-end">
                        <span t-field="doc.subtotal_before_discount"/>
                    </td>
                    <td class="text-end" t-if="inverse_currency_rate != 1 and doc.partner_id.country_id.code == 'PE'  and doc.company_id.show_subtotal_pen">
                        <span t-esc="doc.subtotal_before_discount*inverse_currency_rate" 
                              t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
                    </td>
                </tr>
                <!-- DESCUENTO GLOBAL -->
                <t t-foreach="doc.order_line.filtered(lambda line:line.flag_discount_global)" t-as="line">
                    <tr name="subtotal_descuentos">
                        <td>
                            <strong t-field="line.name"></strong>
                        </td>
                        <td class="text-end">
                            <span t-field="line.price_total"/>
                        </td>
                        <td class="text-end" t-if="inverse_currency_rate != 1 and doc.partner_id.country_id.code == 'PE'  and doc.company_id.show_subtotal_pen">
                            <span t-esc="line.price_total*inverse_currency_rate" 
                                t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
                        </td>
                    </tr>
                </t>
            </t>
            <!--MOSTRAR DESCUENTOS CON SU SIN SUBTOTALES-->
            <t  t-if="doc.total_discounts_untaxed" groups="!external_layout_header_compact.show_sales_invoices_lines_with_taxes">
                <tr name="subtotal_before_discount_untaxed">
                    <td>
                        <strong>SUBTOTAL</strong>
                    </td>
                    <td class="text-end">
                        <span t-field="doc.subtotal_before_discount_untaxed"/>
                    </td>
                    <td class="text-end" t-if="inverse_currency_rate != 1 and doc.partner_id.country_id.code == 'PE'  and doc.company_id.show_subtotal_pen">
                        <span t-esc="doc.subtotal_before_discount_untaxed*inverse_currency_rate" 
                              t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
                    </td>
                </tr>
                <!-- DESCUENTO GLOBAL -->
                <t t-foreach="doc.order_line.filtered(lambda line:line.flag_discount_global)" t-as="line">
                    <tr name="subtotal_descuentos_untaxed">
                        <td>
                            <strong t-field="line.name"></strong>
                        </td>
                        <td class="text-end">
                            -<span t-field="line.price_subtotal"/>
                        </td>
                        <td class="text-end" t-if="inverse_currency_rate != 1 and doc.partner_id.country_id.code == 'PE'  and doc.company_id.show_subtotal_pen">
                            <span t-esc="line.price_subtotal*inverse_currency_rate" 
                                t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
                        </td>
                    </tr>
                </t>
            </t>
            <t t-if="not hide_subtotals">
                <tr name="subtotal_op_gravada" t-if="doc.total_gravado &gt; 0">
                    <td>
                        <strong>OP. GRAVADA</strong>
                    </td>
                    <td class="text-end">
                        <span t-field="doc.total_gravado"/>
                    </td>
                    <td class="text-end" t-if="inverse_currency_rate != 1 and doc.partner_id.country_id.code == 'PE' and doc.company_id.show_subtotal_pen">
                        <span t-esc="doc.total_gravado*inverse_currency_rate" 
                              t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
                    </td>
                </tr>
                <tr name="subtotal_igv" t-if="doc.total_igv &gt; 0">
                    <td>
                        <strong>IGV 18%</strong>
                    </td>
                    <td class="text-end">
                        <span t-field="doc.total_igv"/>
                    </td>
                    <td class="text-end" t-if="inverse_currency_rate != 1 and doc.partner_id.country_id.code == 'PE' and doc.company_id.show_subtotal_pen">
                        <span t-esc="doc.total_igv*inverse_currency_rate" 
                              t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
                    </td>
                </tr>
            </t>
            <tr name="total" class="border-black o_total">
                <td><strong>TOTAL</strong></td>
                <td class="text-end">
                    <span t-field="doc.amount_total"/>
                </td>
                <td class="text-end" t-if="inverse_currency_rate != 1 and doc.partner_id.country_id.code == 'PE' and doc.company_id.show_subtotal_pen">
                    <span t-esc="doc.amount_total*inverse_currency_rate" 
                          t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
                </td>
            </tr>
        </xpath>

        <!--MONTO EN LETRAS-->
        
        <xpath expr="//div[@name='total']/div[1]" position="before">
            <div style="width:60%">
                <strong>Total de Productos Son: <t t-esc="len(doc.order_line.filtered(lambda line:line.display_type == False  and not line.flag_discount_global))"/></strong>
                <br/>
                <strong name="amount_total_words" class="py-1">SON: <t t-esc="doc.currency_id.with_context(lang=doc.partner_id.lang).amount_to_text(doc.amount_total).replace(',','').upper()"/></strong>
            </div>
        </xpath>
        <xpath expr="//div[@name='total']/div[2]" position="attributes">
            <attribute name="t-attf-class"></attribute>
            <attribute name="style">width:40%</attribute>
        </xpath>
        <xpath expr="//div[@name='total']" position="attributes">
            <attribute name="class">d-flex justify-content-between flex-direction-row</attribute>>
        </xpath>
    </template>

</odoo>
